# ============================================================
# ZSH Configuration - Cross-Platform (chezmoi managed)
# ============================================================

# --- Environment ---
typeset -U PATH  # Ensure unique PATH entries
export PATH="$HOME/.local/bin:$PATH"
export PATH="$HOME/.atuin/bin:$PATH"

{{- if eq .chezmoi.os "darwin" }}
# macOS-specific paths
export PATH="$HOME/.bun/bin:$PATH"
{{- end }}

{{- if eq .chezmoi.os "linux" }}
# Linux-specific paths
export PATH="$HOME/.cargo/bin:$PATH"

# Terminal color support
export COLORTERM=truecolor
export TERM=xterm-256color

# AWS CLI configuration
export AWS_CLI_AUTO_PROMPT=on-partial

# Load local AWS environment variables when available
if [[ -f "$HOME/AWS-examples/.aws.env" ]]; then
  set -a
  source "$HOME/AWS-examples/.aws.env"
  set +a
fi
{{- end }}

# --- History ---
HISTFILE=~/.zsh_history
HISTSIZE=50000
SAVEHIST=50000
setopt HIST_IGNORE_ALL_DUPS
setopt HIST_FIND_NO_DUPS
setopt HIST_SAVE_NO_DUPS
setopt SHARE_HISTORY
setopt EXTENDED_HISTORY

# --- Zinit Plugin Manager ---
ZINIT_HOME="${XDG_DATA_HOME:-${HOME}/.local/share}/zinit/zinit.git"
[ ! -d $ZINIT_HOME ] && mkdir -p "$(dirname $ZINIT_HOME)"
[ ! -d $ZINIT_HOME/.git ] && git clone https://github.com/zdharma-continuum/zinit.git "$ZINIT_HOME"
source "${ZINIT_HOME}/zinit.zsh"

# --- Completions (let zinit handle compinit) ---
zinit wait lucid for \
    atinit"zicompinit; zicdreplay" \
    zdharma-continuum/fast-syntax-highlighting \
    atload"_zsh_autosuggest_start" \
    zsh-users/zsh-autosuggestions \
    blockf atpull'zinit creinstall -q .' \
    zsh-users/zsh-completions

# Git workflow enhancement
zinit wait"0a" lucid for wfxr/forgit

# --- mise (replaces nvm/pyenv/rbenv) ---
eval "$(mise activate zsh)"

# --- Modern CLI Tools ---
eval "$(starship init zsh)"
eval "$(zoxide init zsh)"
eval "$(atuin init zsh)"

{{- if eq .chezmoi.os "linux" }}
# Television for fuzzy finding (Linux)
if command -v tv &>/dev/null; then
  eval "$(tv init zsh)"
fi
# fzf completion only (keybindings replaced by television)
if [[ -f /usr/share/doc/fzf/examples/completion.zsh ]]; then
  source /usr/share/doc/fzf/examples/completion.zsh
fi
{{- else }}
# fzf full integration (macOS)
source <(fzf --zsh)
{{- end }}

# --- Eza Aliases (modern ls) ---
alias ls='eza --icons --color=always'
alias la='eza -la --icons --color=always'
alias ll='eza -l --icons --color=always'
alias lt='eza --tree --icons --color=always'
alias l.='eza -ld .* --icons --color=always'
alias lls='eza -la --total-size --icons --color=always'
alias lg='eza -la --git --icons --color=always'

# --- Color Aliases ---
alias grep='grep --color=auto'
alias fgrep='fgrep --color=auto'
alias egrep='egrep --color=auto'
alias diff='diff --color=auto'

# --- Custom Aliases ---
alias zii="zinit"
alias zi="__zoxide_zi"
alias update-all="mise upgrade && mise reshim"

{{- if eq .chezmoi.os "darwin" }}
alias code='/Applications/Visual\ Studio\ Code.app/Contents/Resources/app/bin/code'
{{- end }}

# Claude/Codex aliases
alias claudef="claude --dangerously-skip-permissions"
alias codexf="codex --dangerously-bypass-approvals-and-sandbox"
alias claude-second="CLAUDE_CONFIG_DIR=~/.claude-second claude"
alias claudef2="CLAUDE_CONFIG_DIR=~/.claude-second claude --dangerously-skip-permissions"
alias coderf='coder -- --danger-full-access'
alias ccrf="ccr code --dangerously-skip-permissions"

# AWS profile switching
alias aws-course='export AWS_PROFILE=course'
alias aws-default='export AWS_PROFILE=default'

# --- Session Finders ---
fs() {
    [[ "$1" == "--help" || "$1" == "-h" ]] && { find-session --help; return; }
    eval "$(find-session --shell "$@" | sed '/^$/d')"
}

fcs-codex() {
    [[ "$1" == "--help" || "$1" == "-h" ]] && { find-codex-session --help; return; }
    eval "$(find-codex-session --shell "$@" | sed '/^$/d')"
}

{{- if eq .chezmoi.os "linux" }}
# --- Keychain - SSH and GPG agent management (Linux) ---
if command -v keychain >/dev/null 2>&1; then
    eval $(keychain --eval --quiet --agents ssh)
fi
{{- end }}

# --- Optional Tool Loading ---
[[ -f ~/.tmux_aliases ]] && source ~/.tmux_aliases
[[ -f ~/.config/broot/launcher/bash/br ]] && source ~/.config/broot/launcher/bash/br

{{- if eq .chezmoi.os "darwin" }}
# Bun completions (macOS - standalone install)
[[ -s "$HOME/.bun/_bun" ]] && source "$HOME/.bun/_bun"

# VS Code shell integration (only in VS Code terminal)
[[ "$TERM_PROGRAM" == "vscode" ]] && . "$(code --locate-shell-integration-path zsh)"

# 1Password secrets integration
if command -v op &>/dev/null && [[ -f ~/.secrets/op.env ]]; then
    eval "$(op run --env-file ~/.secrets/op.env -- env | grep -E '^(OPENROUTER|OPENAI|GEMINI)_API_KEY=' | sed 's/^/export /')" 2>/dev/null
fi
{{- end }}

{{- if eq .chezmoi.os "linux" }}
# uv Python tool management
export UV_TOOL_BIN_DIR="$HOME/.local/bin"
{{- end }}
