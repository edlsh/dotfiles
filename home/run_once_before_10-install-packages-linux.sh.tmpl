{{- if eq .chezmoi.os "linux" -}}
#!/bin/bash
# This script runs ONCE on new Linux machines before applying dotfiles

set -eufo pipefail

# Skip if core tools are already installed (existing setup)
if command -v starship &>/dev/null && command -v atuin &>/dev/null && command -v eza &>/dev/null; then
    echo "‚úÖ Core tools already installed, skipping package installation"
    exit 0
fi

echo "üöÄ Setting up Linux dotfiles environment..."

# ============================================================
# Install Linuxbrew if needed
# ============================================================
if ! command -v brew &>/dev/null; then
    echo "üç∫ Installing Linuxbrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
fi

echo "üì¶ Installing essential packages..."
brew bundle --file=/dev/stdin <<EOF
# Shell & Terminal
brew "zsh"
brew "starship"
brew "atuin"
brew "tmux"

# Modern CLI Tools
brew "eza"
brew "bat"
brew "ripgrep"
brew "fd"
brew "fzf"
brew "zoxide"
brew "jq"
brew "yq"
brew "delta"
brew "television"

# Development
brew "neovim"
brew "git"
brew "gh"
brew "mise"

# Utilities
brew "btop"
brew "keychain"
EOF

# ============================================================
# Install 1Password CLI for secrets management
# ============================================================
if ! command -v op &>/dev/null; then
    echo "üîê Installing 1Password CLI..."
    # Add 1Password apt repository
    curl -sS https://downloads.1password.com/linux/keys/1password.asc | \
        sudo gpg --dearmor --output /usr/share/keyrings/1password-archive-keyring.gpg
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/1password-archive-keyring.gpg] https://downloads.1password.com/linux/debian/$(dpkg --print-architecture) stable main" | \
        sudo tee /etc/apt/sources.list.d/1password.list
    sudo mkdir -p /etc/debsig/policies/AC2D62742012EA22/
    curl -sS https://downloads.1password.com/linux/debian/debsig/1password.pol | \
        sudo tee /etc/debsig/policies/AC2D62742012EA22/1password.pol
    sudo mkdir -p /usr/share/debsig/keyrings/AC2D62742012EA22
    curl -sS https://downloads.1password.com/linux/keys/1password.asc | \
        sudo gpg --dearmor --output /usr/share/debsig/keyrings/AC2D62742012EA22/debsig.gpg
    sudo apt update && sudo apt install -y 1password-cli
    echo "‚úÖ 1Password CLI installed!"
fi

echo "‚úÖ Linux package installation complete!"
{{- end }}
