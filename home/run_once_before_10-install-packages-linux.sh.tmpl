{{- if eq .chezmoi.os "linux" -}}
#!/bin/bash
# =============================================================================
# Linux Package Installation Script (run_once)
# Runs ONCE on new Linux machines before applying dotfiles
# Supports: Debian/Ubuntu, Fedora/RHEL, Arch Linux
# =============================================================================

set -eufo pipefail

# Skip if core tools are already installed (existing setup)
if command -v starship &>/dev/null && command -v atuin &>/dev/null && command -v eza &>/dev/null; then
    echo "âœ… Core tools already installed, skipping package installation"
    exit 0
fi

echo "ğŸš€ Setting up Linux dotfiles environment..."

# =============================================================================
# Distro Detection
# =============================================================================
detect_distro() {
    if [ -f /etc/os-release ]; then
        . /etc/os-release
        echo "$ID"
    elif [ -f /etc/debian_version ]; then
        echo "debian"
    elif [ -f /etc/fedora-release ]; then
        echo "fedora"
    elif [ -f /etc/arch-release ]; then
        echo "arch"
    else
        echo "unknown"
    fi
}

DISTRO=$(detect_distro)
echo "ğŸ“‹ Detected distribution: $DISTRO"

# =============================================================================
# Install Linuxbrew (cross-distro package manager)
# =============================================================================
if ! command -v brew &>/dev/null; then
    echo "ğŸº Installing Linuxbrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
fi

# =============================================================================
# Install essential packages via Homebrew
# =============================================================================
echo "ğŸ“¦ Installing essential packages via Homebrew..."
brew bundle --file=/dev/stdin <<EOF
# Shell & Terminal
brew "zsh"
brew "starship"
brew "atuin"
brew "tmux"

# Modern CLI Tools
brew "eza"
brew "bat"
brew "ripgrep"
brew "fd"
brew "fzf"
brew "zoxide"
brew "jq"
brew "yq"
brew "delta"
brew "television"

# Development
brew "neovim"
brew "git"
brew "gh"
brew "mise"

# Utilities
brew "btop"
brew "keychain"
EOF

# =============================================================================
# Install 1Password CLI (distro-specific)
# =============================================================================
if ! command -v op &>/dev/null; then
    echo "ğŸ” Installing 1Password CLI..."
    
    case "$DISTRO" in
        ubuntu|debian)
            # Add 1Password apt repository
            curl -sS https://downloads.1password.com/linux/keys/1password.asc | \
                sudo gpg --dearmor --output /usr/share/keyrings/1password-archive-keyring.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/1password-archive-keyring.gpg] https://downloads.1password.com/linux/debian/$(dpkg --print-architecture) stable main" | \
                sudo tee /etc/apt/sources.list.d/1password.list
            sudo mkdir -p /etc/debsig/policies/AC2D62742012EA22/
            curl -sS https://downloads.1password.com/linux/debian/debsig/1password.pol | \
                sudo tee /etc/debsig/policies/AC2D62742012EA22/1password.pol
            sudo mkdir -p /usr/share/debsig/keyrings/AC2D62742012EA22
            curl -sS https://downloads.1password.com/linux/keys/1password.asc | \
                sudo gpg --dearmor --output /usr/share/debsig/keyrings/AC2D62742012EA22/debsig.gpg
            sudo apt update && sudo apt install -y 1password-cli
            ;;
        fedora|rhel|centos)
            sudo rpm --import https://downloads.1password.com/linux/keys/1password.asc
            sudo sh -c 'echo -e "[1password]\nname=1Password Stable Channel\nbaseurl=https://downloads.1password.com/linux/rpm/stable/\$basearch\nenabled=1\ngpgcheck=1\nrepo_gpgcheck=1\ngpgkey=\"https://downloads.1password.com/linux/keys/1password.asc\"" > /etc/yum.repos.d/1password.repo'
            sudo dnf install -y 1password-cli
            ;;
        arch|manjaro)
            # 1Password CLI available in AUR
            if command -v yay &>/dev/null; then
                yay -S --noconfirm 1password-cli
            elif command -v paru &>/dev/null; then
                paru -S --noconfirm 1password-cli
            else
                echo "âš ï¸  Please install 1password-cli from AUR manually (yay or paru required)"
            fi
            ;;
        *)
            echo "âš ï¸  Unknown distro '$DISTRO' - skipping 1Password CLI installation"
            echo "    Please install manually: https://developer.1password.com/docs/cli/get-started/"
            ;;
    esac
    
    if command -v op &>/dev/null; then
        echo "âœ… 1Password CLI installed!"
    fi
fi

echo "âœ… Linux package installation complete!"
{{- end }}
