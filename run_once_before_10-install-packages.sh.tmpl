#!/bin/bash
# This script runs ONCE on new machines before applying dotfiles

set -eufo pipefail

echo "ğŸš€ Setting up dotfiles environment..."

# ============================================================
# macOS Only
# ============================================================
{{ if eq .chezmoi.os "darwin" -}}

# Skip if core tools are already installed (existing setup)
if command -v starship &>/dev/null && command -v atuin &>/dev/null && command -v eza &>/dev/null; then
    echo "âœ… Core tools already installed, skipping package installation"
    exit 0
fi

# Install Xcode Command Line Tools if needed
if ! xcode-select -p &>/dev/null; then
    echo "ğŸ“¦ Installing Xcode Command Line Tools..."
    xcode-select --install
    echo "â³ Please complete the Xcode installation and re-run chezmoi apply"
    exit 0
fi

# Install Homebrew if needed
if ! command -v brew &>/dev/null; then
    echo "ğŸº Installing Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    eval "$(/opt/homebrew/bin/brew shellenv)"
fi

echo "ğŸ“¦ Installing essential packages..."
brew bundle --file=/dev/stdin <<EOF
# Shell & Terminal
brew "zsh"
brew "starship"
brew "atuin"
brew "tmux"

# Modern CLI Tools
brew "eza"
brew "bat"
brew "ripgrep"
brew "fd"
brew "fzf"
brew "zoxide"
brew "jq"
brew "yq"
brew "television"

# Development
brew "neovim"
brew "git"
brew "gh"
brew "mise"

# Utilities
brew "btop"
brew "broot"

# 1Password CLI (for secrets)
cask "1password-cli"
EOF

{{ end -}}

echo "âœ… Package installation complete!"
